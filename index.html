<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuantumCut — Cybernetic Web Video Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <meta name="description" content="QuantumCut — Pixel-perfect, cybernetic, fast web video editor. Drag-drop timeline, layers, keyframes, color grading, LUTs, and one-click export." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect width=%27100%27 height=%27100%27 fill=%27%23000%27/%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2730%27 fill=%27%2300D1FF%27/%3E%3Ctext x=%2750%25%27 y=%2758%25%27 text-anchor=%27middle%27 fill=%27%23000%27 font-size=%2742%27 font-family=%27monospace%27%3EQ%3C/text%3E%3C/svg%3E" />
  <!-- TailwindCSS (CDN) for responsive and utility classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons: Feather -->
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- FFmpeg.wasm (CDN) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <style>
    :root {
      --qc-bg: #05060a;
      --qc-panel: #0a0d14;
      --qc-panel-2: #0d1117;
      --qc-border: #111827;
      --qc-text: #e5f4ff;
      --qc-muted: #9ecbe6;
      --qc-neon: #00d1ff;
      --qc-neon-2: #3be1ff;
      --qc-danger: #ff3b6e;
      --qc-success: #06d6a0;
      --qc-warning: #ffd166;
      --glass: rgba(5, 8, 16, 0.55);
      --glass-2: rgba(12, 18, 28, 0.65);
      --shadow-neon: 0 0 10px rgba(0,209,255,0.6), inset 0 0 20px rgba(0,209,255,0.12);
    }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 600px at 80% -20%, rgba(0,209,255,0.12), transparent 60%),
                  radial-gradient(900px 400px at 10% 120%, rgba(0,209,255,0.08), transparent 60%),
                  var(--qc-bg);
      color: var(--qc-text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      overscroll-behavior: none;
    }
    /* Grid baseline lines */
    body::before, body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,209,255,0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,209,255,0.06) 1px, transparent 1px);
      background-size: 24px 24px, 24px 24px;
      pointer-events: none;
      mask-image: radial-gradient(600px 600px at 50% 50%, black 10%, transparent 65%);
      z-index: -1;
    }
    /* Neon button */
    .qc-btn {
      background: linear-gradient(180deg, rgba(0,209,255,0.2), rgba(0,209,255,0.08));
      border: 1px solid rgba(0,209,255,0.4);
      color: var(--qc-text);
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: var(--shadow-neon);
      transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease;
      backdrop-filter: blur(8px);
    }
    .qc-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .qc-btn:active { transform: translateY(0); filter: brightness(0.95); }
    .qc-btn-danger { border-color: rgba(255,59,110,0.5); box-shadow: 0 0 10px rgba(255,59,110,0.5), inset 0 0 18px rgba(255,59,110,0.18); background: linear-gradient(180deg, rgba(255,59,110,0.24), rgba(255,59,110,0.08)); }
    .qc-btn-slim { padding: 8px 12px; border-radius: 10px; }
    .qc-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,209,255,0.35);
      background: linear-gradient(180deg, rgba(0,209,255,0.12), rgba(0,209,255,0.04));
      box-shadow: inset 0 0 10px rgba(0,209,255,0.12);
      font-size: 12px;
      color: var(--qc-muted);
    }
    .qc-glass {
      background: var(--glass);
      border: 1px solid rgba(0,209,255,0.2);
      box-shadow: 0 0 24px rgba(0,209,255,0.12), inset 0 0 16px rgba(0,209,255,0.08);
      backdrop-filter: blur(10px);
    }
    .qc-panel {
      background: var(--glass-2);
      border: 1px solid rgba(0,209,255,0.18);
      box-shadow: 0 0 18px rgba(0,209,255,0.12), inset 0 0 20px rgba(0,209,255,0.06);
      backdrop-filter: blur(12px);
      border-radius: 16px;
    }
    .qc-title {
      font-weight: 800;
      letter-spacing: 0.5px;
      color: var(--qc-text);
      text-shadow: 0 0 18px rgba(0,209,255,0.6);
    }
    .qc-subtitle { color: var(--qc-muted); }
    .qc-input {
      background: rgba(2, 6, 12, 0.7);
      border: 1px solid rgba(0,209,255,0.35);
      color: var(--qc-text);
      border-radius: 12px;
      padding: 10px 12px;
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .qc-input:focus {
      outline: none;
      border-color: var(--qc-neon);
      box-shadow: 0 0 14px rgba(0,209,255,0.35);
    }
    .qc-divider {
      height: 1px;
      background: linear-gradient(90deg, rgba(0,209,255,0.2), rgba(0,209,255,0.05));
      border: none;
    }

    /* App Layout */
    #app {
      display: grid;
      grid-template-rows: 56px auto 220px;
      grid-template-columns: 320px auto 320px;
      grid-template-areas:
        "topbar topbar topbar"
        "sidebar preview rightbar"
        "timeline timeline timeline";
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    #topbar { grid-area: topbar; }
    #sidebar { grid-area: sidebar; overflow: auto; }
    #preview { grid-area: preview; overflow: hidden; }
    #rightbar { grid-area: rightbar; overflow: auto; }
    #timeline { grid-area: timeline; overflow: hidden; }

    /* Timeline */
    .timeline-wrap {
      height: 100%;
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 12px;
    }
    .track-list {
      background: rgba(4,8,14,0.6);
      border: 1px solid rgba(0,209,255,0.18);
      border-radius: 14px;
      overflow: auto;
      padding: 8px;
    }
    .track {
      display: grid;
      grid-template-columns: 32px 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: rgba(0,209,255,0.06);
      border: 1px solid rgba(0,209,255,0.26);
    }
    .track .dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--qc-neon);
      box-shadow: 0 0 10px rgba(0,209,255,0.9);
    }
    .timeline-canvas {
      position: relative;
      background:
        linear-gradient(180deg, rgba(0,209,255,0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,209,255,0.06) 1px, transparent 1px);
      background-size: 24px 24px, 24px 24px;
      border: 1px solid rgba(0,209,255,0.18);
      border-radius: 14px;
      overflow: auto;
    }
    .clip {
      position: absolute;
      height: 64px;
      min-width: 80px;
      background: linear-gradient(180deg, rgba(0,209,255,0.22), rgba(0,209,255,0.1));
      border: 1px solid rgba(0,209,255,0.4);
      border-radius: 12px;
      box-shadow: var(--shadow-neon);
      color: var(--qc-text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      cursor: grab;
    }
    .clip:active { cursor: grabbing; }
    .clip .handle {
      width: 10px;
      height: 100%;
      border-radius: 10px;
      background: rgba(0,209,255,0.22);
      border-left: 1px solid rgba(0,209,255,0.4);
      border-right: 1px solid rgba(0,209,255,0.4);
      cursor: col-resize;
    }
    .playhead {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: var(--qc-neon);
      box-shadow: 0 0 12px rgba(0,209,255,0.9);
      pointer-events: none;
    }

    /* Preview */
    .preview-wrap {
      height: 100%;
      display: grid;
      grid-template-rows: auto 180px;
      gap: 12px;
    }
    .preview-stage {
      position: relative;
      background: #000000;
      border: 1px solid rgba(0,209,255,0.22);
      border-radius: 16px;
      box-shadow: 0 0 18px rgba(0,209,255,0.12);
      overflow: hidden;
    }
    .preview-stage .hud {
      position: absolute;
      top: 8px; left: 8px;
      display: flex; gap: 8px;
    }
    .hud .meter {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,209,255,0.12);
      border: 1px solid rgba(0,209,255,0.35);
      color: var(--qc-muted);
      font-size: 12px;
    }
    .preview-controls {
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 10px;
    }

    /* Rightbar panels */
    .panel-title {
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--qc-muted);
    }
    .slider-row {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }
    .qc-slider {
      appearance: none;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(0,209,255,0.12), rgba(0,209,255,0.22));
      border: 1px solid rgba(0,209,255,0.35);
      box-shadow: inset 0 0 14px rgba(0,209,255,0.18);
      outline: none;
    }
    .qc-slider::-webkit-slider-thumb {
      appearance: none;
      width: 18px; height: 18px; border-radius: 999px;
      background: var(--qc-neon);
      box-shadow: 0 0 12px rgba(0,209,255,0.7);
      border: 2px solid #03141a;
      cursor: pointer;
    }

    /* Auth screen */
    #auth {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: radial-gradient(800px 500px at 80% -10%, rgba(0,209,255,0.14), transparent 60%),
                  radial-gradient(600px 400px at 10% 110%, rgba(0,209,255,0.1), transparent 60%),
                  #04060a;
      z-index: 50;
    }
    .logo-mark {
      font-weight: 900;
      font-size: 28px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .logo-dot {
      width: 14px; height: 14px; border-radius: 999px;
      background: var(--qc-neon);
      box-shadow: 0 0 16px rgba(0,209,255,0.9);
    }

    /* Toasts */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(2, 8, 12, 0.8);
      border: 1px solid rgba(0,209,255,0.25);
      color: var(--qc-text);
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,209,255,0.12);
      backdrop-filter: blur(10px);
      z-index: 60;
      font-size: 13px;
    }

    /* Fullscreen */
    .fullscreen .preview-stage { height: calc(100vh - 72px); }
    .fullscreen #sidebar, .fullscreen #rightbar, .fullscreen #timeline { display: none; }
    .fullscreen #app { grid-template-rows: 56px auto; grid-template-columns: 1fr; grid-template-areas: "topbar" "preview"; }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <section id="auth" aria-label="QuantumCut Login">
    <div class="qc-panel max-w-md w-[92%] p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="logo-mark qc-title">
          <span class="logo-dot"></span> QuantumCut
        </div>
        <span class="qc-chip">Black + Neon Blue • Cybernetic</span>
      </div>

      <p class="qc-subtitle mb-4">Free to use. Create a username and password to save your projects.</p>

      <div class="grid gap-3">
        <label class="text-sm qc-muted">Username</label>
        <input id="auth-username" class="qc-input" type="text" placeholder="Enter username" />
        <label class="text-sm qc-muted mt-2">Password</label>
        <input id="auth-password" class="qc-input" type="password" placeholder="Enter password" />
        <label class="text-sm qc-muted mt-2">Email (optional)</label>
        <input id="auth-email" class="qc-input" type="email" placeholder="name@example.com" />
      </div>

      <div class="flex items-center gap-2 mt-4">
        <button id="btn-signup" class="qc-btn">Sign up</button>
        <button id="btn-login" class="qc-btn">Log in</button>
        <button id="btn-demo" class="qc-btn qc-btn-slim">Try demo</button>
      </div>

      <hr class="qc-divider my-4" />

      <div class="grid gap-2">
        <div class="flex items-center gap-2">
          <input id="use-firebase" type="checkbox" />
          <label for="use-firebase" class="text-sm qc-muted">Use Firebase for cloud storage</label>
        </div>
        <details class="qc-glass p-3 rounded-lg">
          <summary class="cursor-pointer text-sm qc-muted">Firebase config (optional)</summary>
          <div class="grid gap-2 mt-3">
            <input id="firebase-apiKey" class="qc-input" placeholder="apiKey" />
            <input id="firebase-authDomain" class="qc-input" placeholder="authDomain" />
            <input id="firebase-projectId" class="qc-input" placeholder="projectId" />
            <input id="firebase-storageBucket" class="qc-input" placeholder="storageBucket" />
            <input id="firebase-messagingSenderId" class="qc-input" placeholder="messagingSenderId" />
            <input id="firebase-appId" class="qc-input" placeholder="appId" />
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="hidden">
    <!-- TOPBAR -->
    <header id="topbar" class="qc-panel flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <div class="logo-mark qc-title">
          <span class="logo-dot"></span> QuantumCut
        </div>
        <span class="qc-chip">Pixel-perfect • Cybernetic • Fast</span>
      </div>

      <div class="flex items-center gap-2">
        <button id="btn-import" class="qc-btn">
          <i data-feather="upload"></i>
          <span class="ml-2">Import</span>
        </button>
        <button id="btn-export" class="qc-btn">
          <i data-feather="download"></i>
          <span class="ml-2">Export</span>
        </button>
        <button id="btn-save" class="qc-btn">
          <i data-feather="save"></i>
          <span class="ml-2">Save</span>
        </button>
        <button id="btn-undo" class="qc-btn qc-btn-slim" title="Undo">
          <i data-feather="rotate-ccw"></i>
        </button>
        <button id="btn-redo" class="qc-btn qc-btn-slim" title="Redo">
          <i data-feather="rotate-cw"></i>
        </button>
        <button id="btn-fullscreen" class="qc-btn qc-btn-slim" title="Fullscreen">
          <i data-feather="maximize"></i>
        </button>
        <button id="btn-logout" class="qc-btn qc-btn-danger qc-btn-slim" title="Logout">
          <i data-feather="log-out"></i>
        </button>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="qc-panel p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="panel-title">Library</div>
        <button id="btn-add-text" class="qc-btn qc-btn-slim">
          <i data-feather="type"></i><span class="ml-2">Text</span>
        </button>
      </div>
      <div class="grid gap-2">
        <div class="qc-glass p-2 rounded-lg">
          <div class="panel-title mb-2">Media</div>
          <input id="file-input" type="file" accept="video/*,audio/*,image/*" multiple class="qc-input w-full" />
          <div id="media-list" class="grid grid-cols-2 gap-2 mt-2"></div>
        </div>
        <div class="qc-glass p-2 rounded-lg">
          <div class="panel-title mb-2">Transitions</div>
          <div id="transitions-list" class="grid grid-cols-2 gap-2"></div>
        </div>
        <div class="qc-glass p-2 rounded-lg">
          <div class="panel-title mb-2">Effects & Filters</div>
          <div id="effects-list" class="grid grid-cols-2 gap-2"></div>
        </div>
      </div>
    </aside>

    <!-- PREVIEW -->
    <section id="preview" class="qc-panel p-3">
      <div class="preview-wrap">
        <div class="preview-stage" id="preview-stage">
          <canvas id="preview-canvas"></canvas>
          <div class="hud">
            <div class="meter">FPS: <span id="hud-fps">0</span></div>
            <div class="meter">Time: <span id="hud-time">0.00s</span></div>
            <div class="meter">Scale: <span id="hud-scale">100%</span></div>
          </div>
        </div>
        <div class="preview-controls">
          <div class="flex items-center gap-2">
            <button id="btn-play" class="qc-btn qc-btn-slim"><i data-feather="play"></i></button>
            <button id="btn-pause" class="qc-btn qc-btn-slim"><i data-feather="pause"></i></button>
            <button id="btn-stop" class="qc-btn qc-btn-slim"><i data-feather="square"></i></button>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-snap" class="qc-btn qc-btn-slim"><i data-feather="grid"></i><span class="ml-2">Snap</span></button>
            <button id="btn-magnet" class="qc-btn qc-btn-slim"><i data-feather="magnet"></i><span class="ml-2">Magnet</span></button>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-add-key" class="qc-btn qc-btn-slim"><i data-feather="key"></i><span class="ml-2">Add keyframe</span></button>
            <button id="btn-text-anim" class="qc-btn qc-btn-slim"><i data-feather="italic"></i><span class="ml-2">Text anim</span></button>
          </div>
          <div class="flex items-center gap-2 justify-self-end">
            <select id="preview-scale" class="qc-input">
              <option value="0.5">50%</option>
              <option value="0.75">75%</option>
              <option value="1" selected>100%</option>
              <option value="1.5">150%</option>
              <option value="2">200%</option>
            </select>
            <button id="btn-scope" class="qc-btn qc-btn-slim"><i data-feather="activity"></i><span class="ml-2">Scopes</span></button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHTBAR -->
    <aside id="rightbar" class="qc-panel p-3">
      <div class="grid gap-3">
        <div class="qc-glass p-3 rounded-lg">
          <div class="panel-title">Color grading</div>
          <div class="slider-row">
            <span class="qc-muted">Exposure</span>
            <input id="grade-exposure" type="range" min="-2" max="2" step="0.01" value="0" class="qc-slider" />
            <span id="grade-exposure-val" class="qc-chip">0</span>
          </div>
          <div class="slider-row">
            <span class="qc-muted">Contrast</span>
            <input id="grade-contrast" type="range" min="0" max="2" step="0.01" value="1" class="qc-slider" />
            <span id="grade-contrast-val" class="qc-chip">1</span>
          </div>
          <div class="slider-row">
            <span class="qc-muted">Saturation</span>
            <input id="grade-sat" type="range" min="0" max="2" step="0.01" value="1" class="qc-slider" />
            <span id="grade-sat-val" class="qc-chip">1</span>
          </div>
          <div class="slider-row">
            <span class="qc-muted">Temperature</span>
            <input id="grade-temp" type="range" min="-1" max="1" step="0.01" value="0" class="qc-slider" />
            <span id="grade-temp-val" class="qc-chip">0</span>
          </div>
          <div class="slider-row">
            <span class="qc-muted">Tint</span>
            <input id="grade-tint" type="range" min="-1" max="1" step="0.01" value="0" class="qc-slider" />
            <span id="grade-tint-val" class="qc-chip">0</span>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <input id="lut-file" type="file" accept=".cube,.3dl" class="qc-input" />
            <button id="btn-load-lut" class="qc-btn qc-btn-slim"><i data-feather="file-plus"></i><span class="ml-2">Load LUT</span></button>
          </div>
        </div>

        <div class="qc-glass p-3 rounded-lg">
          <div class="panel-title mb-2">Audio mixing</div>
          <div class="slider-row">
            <span class="qc-muted">Master volume</span>
            <input id="audio-master" type="range" min="0" max="1" step="0.01" value="1" class="qc-slider" />
            <span id="audio-master-val" class="qc-chip">1.00</span>
          </div>
          <div class="slider-row">
            <span class="qc-muted">Duck music</span>
            <input id="audio-duck" type="range" min="0" max="1" step="0.05" value="0" class="qc-slider" />
            <span id="audio-duck-val" class="qc-chip">0.00</span>
          </div>
          <div class="flex items-center gap-2 mt-1">
            <button id="btn-audio-mute" class="qc-btn qc-btn-slim"><i data-feather="volume-x"></i><span class="ml-2">Mute</span></button>
            <button id="btn-audio-solo" class="qc-btn qc-btn-slim"><i data-feather="headphones"></i><span class="ml-2">Solo</span></button>
          </div>
        </div>

        <div class="qc-glass p-3 rounded-lg">
          <div class="panel-title mb-2">Keyframes & motion</div>
          <div class="grid gap-2">
            <div class="slider-row">
              <span class="qc-muted">Position X</span>
              <input id="motion-x" type="range" min="-400" max="400" step="1" value="0" class="qc-slider" />
              <span id="motion-x-val" class="qc-chip">0</span>
            </div>
            <div class="slider-row">
              <span class="qc-muted">Position Y</span>
              <input id="motion-y" type="range" min="-400" max="400" step="1" value="0" class="qc-slider" />
              <span id="motion-y-val" class="qc-chip">0</span>
            </div>
            <div class="slider-row">
              <span class="qc-muted">Scale</span>
              <input id="motion-scale" type="range" min="0.2" max="3" step="0.01" value="1" class="qc-slider" />
              <span id="motion-scale-val" class="qc-chip">1</span>
            </div>
            <div class="slider-row">
              <span class="qc-muted">Rotation</span>
              <input id="motion-rot" type="range" min="-180" max="180" step="1" value="0" class="qc-slider" />
              <span id="motion-rot-val" class="qc-chip">0°</span>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <button id="btn-ease-in" class="qc-btn qc-btn-slim">Ease In</button>
              <button id="btn-ease-out" class="qc-btn qc-btn-slim">Ease Out</button>
              <button id="btn-ease-inout" class="qc-btn qc-btn-slim">Ease In-Out</button>
            </div>
          </div>
        </div>

        <div class="qc-glass p-3 rounded-lg">
          <div class="panel-title mb-2">Text & graphics</div>
          <div class="grid gap-2">
            <input id="text-content" class="qc-input" placeholder="Your cybernetic title…" />
            <div class="slider-row">
              <span class="qc-muted">Size</span>
              <input id="text-size" type="range" min="12" max="160" step="1" value="48" class="qc-slider" />
              <span id="text-size-val" class="qc-chip">48</span>
            </div>
            <div class="slider-row">
              <span class="qc-muted">Tracking</span>
              <input id="text-track" type="range" min="-0.1" max="0.5" step="0.01" value="0.02" class="qc-slider" />
              <span id="text-track-val" class="qc-chip">0.02</span>
            </div>
            <div class="flex items-center gap-2">
              <button id="btn-text-glow" class="qc-btn qc-btn-slim">Neon glow</button>
              <button id="btn-text-typewriter" class="qc-btn qc-btn-slim">Typewriter</button>
              <button id="btn-text-slide" class="qc-btn qc-btn-slim">Slide-in</button>
            </div>
          </div>
        </div>

        <div class="qc-glass p-3 rounded-lg">
          <div class="panel-title mb-2">Scopes</div>
          <div class="grid grid-cols-2 gap-2">
            <canvas id="scope-waveform" height="140"></canvas>
            <canvas id="scope-vectorscope" height="140"></canvas>
          </div>
        </div>
      </div>
    </aside>

    <!-- TIMELINE -->
    <section id="timeline" class="qc-panel p-3">
      <div class="timeline-wrap">
        <div class="track-list">
          <div class="flex items-center justify-between mb-2">
            <div class="panel-title">Tracks</div>
            <div class="flex items-center gap-2">
              <button id="btn-add-vtrack" class="qc-btn qc-btn-slim">+ Video</button>
              <button id="btn-add-atrack" class="qc-btn qc-btn-slim">+ Audio</button>
              <button id="btn-add-ttrack" class="qc-btn qc-btn-slim">+ Text</button>
            </div>
          </div>
          <div id="tracks"></div>
        </div>
        <div id="timeline-canvas" class="timeline-canvas">
          <div id="timeline-grid" style="position:relative; width:3200px; height:180px;">
            <div id="playhead" class="playhead" style="left: 120px;"></div>
            <!-- Clips rendered dynamically -->
          </div>
          <div class="flex items-center justify-between p-2">
            <div class="qc-chip">Drag & drop media into the timeline • Resize clip ends • Double-click to edit</div>
            <div class="flex items-center gap-2">
              <button id="btn-zoom-out" class="qc-btn qc-btn-slim"><i data-feather="minus"></i></button>
              <button id="btn-zoom-in" class="qc-btn qc-btn-slim"><i data-feather="plus"></i></button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script>
    feather.replace({ color: '#9ecbe6' });

    // --- Simple Toast ---
    const toastEl = document.getElementById('toast');
    function toast(msg, ms = 1800) {
      toastEl.textContent = msg;
      toastEl.classList.remove('hidden');
      setTimeout(() => toastEl.classList.add('hidden'), ms);
    }

    // --- Auth ---
    const authEl = document.getElementById('auth');
    const appEl = document.getElementById('app');
    const usernameEl = document.getElementById('auth-username');
    const passwordEl = document.getElementById('auth-password');
    const emailEl = document.getElementById('auth-email');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogin = document.getElementById('btn-login');
    const btnDemo = document.getElementById('btn-demo');
    const btnLogout = document.getElementById('btn-logout');
    const useFirebaseEl = document.getElementById('use-firebase');

    const authStore = {
      key: 'qc_users',
      sessionKey: 'qc_session',
      users: JSON.parse(localStorage.getItem('qc_users') || '{}'),
      save() { localStorage.setItem(this.key, JSON.stringify(this.users)); },
      setSession(username) { localStorage.setItem(this.sessionKey, JSON.stringify({ username })); },
      clearSession() { localStorage.removeItem(this.sessionKey); }
    };

    function enterApp(username) {
      authStore.setSession(username);
      authEl.classList.add('hidden');
      appEl.classList.remove('hidden');
      toast(`Welcome, ${username}. QuantumCut is armed.`);
    }

    btnSignup.onclick = () => {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      if (!u || !p) return toast('Username and password required.');
      if (authStore.users[u]) return toast('User already exists. Log in.');
      authStore.users[u] = { password: p, email: emailEl.value || null };
      authStore.save();
      toast('Signup successful. Logging you in…');
      enterApp(u);
    };

    btnLogin.onclick = () => {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      const user = authStore.users[u];
      if (!user || user.password !== p) return toast('Invalid credentials.');
      enterApp(u);
    };

    btnDemo.onclick = () => enterApp('DemoUser');

    btnLogout.onclick = () => {
      authStore.clearSession();
      appEl.classList.add('hidden');
      authEl.classList.remove('hidden');
      toast('Logged out.');
    };

    // Auto-login if session exists
    const existingSession = JSON.parse(localStorage.getItem(authStore.sessionKey) || 'null');
    if (existingSession?.username) enterApp(existingSession.username);

    // --- Firebase (optional plumb) ---
    const firebaseConfigInputs = {
      apiKey: document.getElementById('firebase-apiKey'),
      authDomain: document.getElementById('firebase-authDomain'),
      projectId: document.getElementById('firebase-projectId'),
      storageBucket: document.getElementById('firebase-storageBucket'),
      messagingSenderId: document.getElementById('firebase-messagingSenderId'),
      appId: document.getElementById('firebase-appId')
    };
    function getFirebaseConfig() {
      return {
        apiKey: firebaseConfigInputs.apiKey.value,
        authDomain: firebaseConfigInputs.authDomain.value,
        projectId: firebaseConfigInputs.projectId.value,
        storageBucket: firebaseConfigInputs.storageBucket.value,
        messagingSenderId: firebaseConfigInputs.messagingSenderId.value,
        appId: firebaseConfigInputs.appId.value
      };
    }

    // --- State ---
    const state = {
      projectName: 'Untitled QuantumCut',
      tracks: [], // { id, type: 'video'|'audio'|'text', name }
      clips: [],  // { id, trackId, start, duration, type, media?, text?, params }
      timelineScale: 1.0, // affects pixel-per-second
      pixelPerSecondBase: 120, // base zoom
      playing: false,
      currentTime: 0,
      selection: null,
      keyframes: {}, // clipId -> [{t, props}]
      grading: { exposure: 0, contrast: 1, sat: 1, temp: 0, tint: 0, lut: null },
      audio: { master: 1, duck: 0, mute: false, solo: false },
      motion: { x: 0, y: 0, scale: 1, rot: 0, ease: 'linear' },
      text: { content: 'QUANTUMCUT', size: 48, track: 0.02, glow: false, anim: null },
      history: [],
      future: [],
    };

    // --- Helpers ---
    function pushHistory() {
      state.history.push(JSON.stringify({ tracks: state.tracks, clips: state.clips, keyframes: state.keyframes }));
      state.future = [];
    }
    function undo() {
      if (!state.history.length) return toast('Nothing to undo.');
      const snap = state.history.pop();
      state.future.push(JSON.stringify({ tracks: state.tracks, clips: state.clips, keyframes: state.keyframes }));
      const obj = JSON.parse(snap);
      state.tracks = obj.tracks;
      state.clips = obj.clips;
      state.keyframes = obj.keyframes;
      renderTracks();
      renderTimeline();
    }
    function redo() {
      if (!state.future.length) return toast('Nothing to redo.');
      const snap = state.future.pop();
      state.history.push(JSON.stringify({ tracks: state.tracks, clips: state.clips, keyframes: state.keyframes }));
      const obj = JSON.parse(snap);
      state.tracks = obj.tracks;
      state.clips = obj.clips;
      state.keyframes = obj.keyframes;
      renderTracks();
      renderTimeline();
    }

    document.getElementById('btn-undo').onclick = undo;
    document.getElementById('btn-redo').onclick = redo;

    // --- Tracks ---
    const tracksEl = document.getElementById('tracks');
    const btnAddV = document.getElementById('btn-add-vtrack');
    const btnAddA = document.getElementById('btn-add-atrack');
    const btnAddT = document.getElementById('btn-add-ttrack');

    function addTrack(type) {
      const id = 'trk_' + Math.random().toString(36).slice(2, 8);
      const name = (type === 'video' ? 'V' : type === 'audio' ? 'A' : 'T') + '-' + (state.tracks.filter(t => t.type === type).length + 1);
      state.tracks.push({ id, type, name });
      pushHistory();
      renderTracks();
    }
    btnAddV.onclick = () => addTrack('video');
    btnAddA.onclick = () => addTrack('audio');
    btnAddT.onclick = () => addTrack('text');

    function renderTracks() {
      tracksEl.innerHTML = '';
      state.tracks.forEach(t => {
        const row = document.createElement('div');
        row.className = 'track';
        row.innerHTML = `
          <div class="dot"></div>
          <div class="flex items-center gap-2">
            <span>${t.name}</span>
            <span class="qc-chip">${t.type.toUpperCase()}</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="qc-btn qc-btn-slim" data-mute="${t.id}"><i data-feather="volume-x"></i></button>
            <button class="qc-btn qc-btn-slim" data-solo="${t.id}"><i data-feather="headphones"></i></button>
            <button class="qc-btn qc-btn-slim" data-del="${t.id}"><i data-feather="trash-2"></i></button>
          </div>
        `;
        tracksEl.appendChild(row);
      });
      feather.replace();
      // Attach events
      document.querySelectorAll('[data-del]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-del');
          state.clips = state.clips.filter(c => c.trackId !== id);
          state.tracks = state.tracks.filter(t => t.id !== id);
          pushHistory();
          renderTracks(); renderTimeline();
        };
      });
    }
    addTrack('video'); addTrack('audio'); addTrack('text'); // default tracks

    // --- Media Library ---
    const fileInput = document.getElementById('file-input');
    const mediaList = document.getElementById('media-list');
    const transitionsList = document.getElementById('transitions-list');
    const effectsList = document.getElementById('effects-list');

    const transitions = [
      { id: 'cut', name: 'Cut' },
      { id: 'fade', name: 'Fade' },
      { id: 'cross', name: 'Crossfade' },
      { id: 'slide', name: 'Slide' },
      { id: 'zoom', name: 'Zoom' },
      { id: 'glitch', name: 'Glitch' },
    ];
    const effects = [
      { id: 'blur', name: 'Blur' },
      { id: 'sharpen', name: 'Sharpen' },
      { id: 'bloom', name: 'Bloom' },
      { id: 'vhs', name: 'VHS' },
      { id: 'chromatic', name: 'Chromatic ab.' },
      { id: 'noise', name: 'Noise' },
    ];
    transitions.forEach(tr => {
      const item = document.createElement('button');
      item.className = 'qc-btn qc-btn-slim';
      item.textContent = tr.name;
      item.draggable = true;
      item.ondragstart = ev => { ev.dataTransfer.setData('transition', tr.id); };
      transitionsList.appendChild(item);
    });
    effects.forEach(ef => {
      const item = document.createElement('button');
      item.className = 'qc-btn qc-btn-slim';
      item.textContent = ef.name;
      item.draggable = true;
      item.ondragstart = ev => { ev.dataTransfer.setData('effect', ef.id); };
      effectsList.appendChild(item);
    });

    const mediaItems = [];
    fileInput.onchange = async (e) => {
      const files = Array.from(e.target.files);
      for (const f of files) {
        const url = URL.createObjectURL(f);
        const type = f.type.startsWith('video') ? 'video' : f.type.startsWith('audio') ? 'audio' : 'image';
        mediaItems.push({ id: 'm_' + Math.random().toString(36).slice(2, 8), name: f.name, url, type });
      }
      renderMedia();
      toast('Media imported. Drag to timeline.');
    };
    function renderMedia() {
      mediaList.innerHTML = '';
      mediaItems.forEach(m => {
        const card = document.createElement('div');
        card.className = 'qc-glass rounded-lg p-2 flex items-center justify-between';
        card.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="dot"></div>
            <div>
              <div>${m.name}</div>
              <div class="qc-subtitle text-xs">${m.type.toUpperCase()}</div>
            </div>
          </div>
          <button class="qc-btn qc-btn-slim" data-add="${m.id}">Add</button>
        `;
        card.draggable = true;
        card.ondragstart = ev => { ev.dataTransfer.setData('mediaId', m.id); };
        mediaList.appendChild(card);
      });
      document.querySelectorAll('[data-add]').forEach(btn => {
        btn.onclick = () => addMediaClip(btn.getAttribute('data-add'));
      });
    }

    function addMediaClip(mediaId) {
      const m = mediaItems.find(x => x.id === mediaId);
      if (!m) return;
      // Place on first matching track
      const t = (m.type === 'video' || m.type === 'image') ? state.tracks.find(T => T.type === 'video') :
                state.tracks.find(T => T.type === 'audio');
      if (!t) return toast('No track available for this media type.');
      const id = 'clip_' + Math.random().toString(36).slice(2, 8);
      state.clips.push({
        id, trackId: t.id, start: state.currentTime, duration: 4, type: m.type,
        media: m, params: { transition: 'cut', effects: [] }
      });
      pushHistory();
      renderTimeline();
    }

    // --- Timeline ---
    const timelineCanvas = document.getElementById('timeline-canvas');
    const timelineGrid = document.getElementById('timeline-grid');
    const playheadEl = document.getElementById('playhead');

    timelineCanvas.ondragover = ev => ev.preventDefault();
    timelineCanvas.ondrop = ev => {
      ev.preventDefault();
      const mediaId = ev.dataTransfer.getData('mediaId');
      if (mediaId) addMediaClip(mediaId);
    };

    function pxPerSecond() {
      return state.pixelPerSecondBase * state.timelineScale;
    }
    function timeToPx(t) { return Math.max(0, Math.round(t * pxPerSecond())); }
    function pxToTime(px) { return px / pxPerSecond(); }

    function renderTimeline() {
      // Clear clips
      timelineGrid.querySelectorAll('.clip').forEach(c => c.remove());
      // Render clips per track row
      const trackIndexMap = {};
      state.tracks.forEach((t, i) => trackIndexMap[t.id] = i);
      const rowHeight = 64 + 12;
      timelineGrid.style.height = Math.max(180, rowHeight * state.tracks.length + 24) + 'px';

      state.clips.forEach(clip => {
        const y = 12 + trackIndexMap[clip.trackId] * rowHeight;
        const x = timeToPx(clip.start);
        const w = timeToPx(clip.duration);
        const el = document.createElement('div');
        el.className = 'clip';
        el.style.top = y + 'px';
        el.style.left = x + 'px';
        el.style.width = w + 'px';
        el.setAttribute('data-id', clip.id);
        el.innerHTML = `
          <div class="handle" data-left="${clip.id}"></div>
          <div class="flex-1 px-2 text-xs">
            <div class="font-bold">${clip.media ? clip.media.name : clip.type.toUpperCase()}</div>
            <div class="qc-subtitle">${clip.params.transition}${clip.params.effects.length ? ' • ' + clip.params.effects.join(', ') : ''}</div>
          </div>
          <div class="handle" data-right="${clip.id}"></div>
        `;
        // Drag move
        let startX = 0, startLeft = x;
        el.onmousedown = (ev) => {
          if (ev.target.hasAttribute('data-left') || ev.target.hasAttribute('data-right')) return;
          ev.preventDefault();
          startX = ev.clientX;
          startLeft = el.offsetLeft;
          const onMove = (mv) => {
            const dx = mv.clientX - startX;
            const nx = Math.max(0, startLeft + dx);
            el.style.left = nx + 'px';
            clip.start = pxToTime(nx);
            state.currentTime = clip.start;
            playheadEl.style.left = nx + 'px';
          };
          const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            pushHistory();
          };
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        };
        // Resize left
        el.querySelector('[data-left]').onmousedown = (ev) => {
          ev.preventDefault();
          const handle = ev.target;
          const startW = el.offsetWidth;
          const startLeft2 = el.offsetLeft;
          const startX2 = ev.clientX;
          const onMove = (mv) => {
            const dx = mv.clientX - startX2;
            const nw = Math.max(80, startW - dx);
            const nl = Math.max(0, startLeft2 + dx);
            el.style.width = nw + 'px';
            el.style.left = nl + 'px';
            clip.start = pxToTime(nl);
            clip.duration = pxToTime(nw);
          };
          const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            pushHistory();
          };
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        };
        // Resize right
        el.querySelector('[data-right]').onmousedown = (ev) => {
          ev.preventDefault();
          const startW = el.offsetWidth;
          const startX3 = ev.clientX;
          const onMove = (mv) => {
            const dx = mv.clientX - startX3;
            const nw = Math.max(80, startW + dx);
            el.style.width = nw + 'px';
            clip.duration = pxToTime(nw);
          };
          const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            pushHistory();
          };
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        };

        // Accept dragged transitions/effects
        el.ondragover = ev => ev.preventDefault();
        el.ondrop = ev => {
          ev.preventDefault();
          const tr = ev.dataTransfer.getData('transition');
          const ef = ev.dataTransfer.getData('effect');
          if (tr) clip.params.transition = tr;
          if (ef) clip.params.effects.push(ef);
          renderTimeline();
        };

        timelineGrid.appendChild(el);
      });
    }
    renderTimeline();

    document.getElementById('btn-zoom-in').onclick = () => {
      state.timelineScale = Math.min(3, state.timelineScale + 0.1);
      renderTimeline();
    };
    document.getElementById('btn-zoom-out').onclick = () => {
      state.timelineScale = Math.max(0.4, state.timelineScale - 0.1);
      renderTimeline();
    };

    // --- Playhead and Preview ---
    const previewCanvas = document.getElementById('preview-canvas');
    const previewStage = document.getElementById('preview-stage');
    const hudFPS = document.getElementById('hud-fps');
    const hudTime = document.getElementById('hud-time');
    const hudScale = document.getElementById('hud-scale');
    const previewScaleEl = document.getElementById('preview-scale');

    function resizePreviewCanvas() {
      const scale = parseFloat(previewScaleEl.value);
      const w = Math.round(previewStage.clientWidth * (1 / scale));
      const h = Math.round((previewStage.clientHeight - 0) * (1 / scale));
      previewCanvas.width = Math.max(320, w);
      previewCanvas.height = Math.max(180, h);
      hudScale.textContent = Math.round(scale * 100) + '%';
    }
    window.addEventListener('resize', resizePreviewCanvas);
    previewScaleEl.onchange = resizePreviewCanvas;
    resizePreviewCanvas();

    let lastFrame = performance.now();
    let fpsCounter = { frames: 0, last: performance.now() };

    const ctx = previewCanvas.getContext('2d');

    function renderPreview(ts) {
      const dt = (ts - lastFrame) / 1000;
      lastFrame = ts;
      ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

      // Simple layer-based render: draw text and rectangles for media clips currently visible
      // Determine active clips at current time
      const current = state.currentTime;
      const activeClips = state.clips.filter(c => current >= c.start && current <= c.start + c.duration);

      // Background
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);

      // Apply grading (naive preview simulation)
      const exposure = state.grading.exposure;
      const contrast = state.grading.contrast;
      const sat = state.grading.sat;

      // Draw active clips as colored blocks (video/image) and waveform bars (audio)
      activeClips.forEach((c, idx) => {
        const baseX = 20 + idx * 30 + state.motion.x;
        const baseY = 40 + idx * 30 + state.motion.y;
        const scale = state.motion.scale;
        const rot = state.motion.rot * Math.PI / 180;
        ctx.save();
        ctx.translate(baseX, baseY);
        ctx.rotate(rot);
        ctx.scale(scale, scale);

        if (c.type === 'video' || c.type === 'image') {
          const w = 240, h = 140;
          // Simulate color grading by neon borders and exposure/contrast tint
          const grad = ctx.createLinearGradient(0, 0, w, h);
          grad.addColorStop(0, `rgba(0,209,255,${0.2 + exposure * 0.15})`);
          grad.addColorStop(1, `rgba(0,209,255,${0.08 + contrast * 0.1})`);
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, w, h);
          ctx.strokeStyle = `rgba(0,209,255,${0.5 + sat * 0.2})`;
          ctx.lineWidth = 2;
          ctx.strokeRect(0, 0, w, h);
          // Effects badges
          ctx.fillStyle = 'rgba(0,209,255,0.6)';
          ctx.font = '12px monospace';
          ctx.fillText(`${c.params.transition}${c.params.effects.length ? ' + ' + c.params.effects.join(',') : ''}`, 8, 16);
        } else if (c.type === 'audio') {
          const w = 260, h = 80;
          ctx.strokeStyle = 'rgba(0,209,255,0.8)';
          ctx.strokeRect(0, 0, w, h);
          // Fake waveform
          ctx.beginPath();
          for (let x = 0; x < w; x++) {
            const y = h/2 + Math.sin((x + ts/10) / 10) * 20 * state.audio.master * (1 - state.audio.duck);
            if (x === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        }
        ctx.restore();
      });

      // Text layer
      if (state.text.content) {
        ctx.save();
        ctx.translate(previewCanvas.width/2 + state.motion.x, 40 + state.motion.y);
        ctx.rotate(state.motion.rot * Math.PI/180);
        ctx.scale(state.motion.scale, state.motion.scale);

        ctx.font = `bold ${state.text.size}px Inter, system-ui, sans-serif`;
        ctx.textAlign = 'center';
        ctx.fillStyle = 'white';
        ctx.filter = state.text.glow ? 'drop-shadow(0 0 12px rgba(0,209,255,0.8))' : 'none';
        const content = (state.text.anim === 'typewriter')
          ? state.text.content.slice(0, Math.max(1, Math.floor((ts/200) % (state.text.content.length + 1))))
          : state.text.content;
        ctx.fillText(content, 0, 0);

        ctx.restore();
      }

      // FPS HUD
      fpsCounter.frames++;
      if (ts - fpsCounter.last > 1000) {
        hudFPS.textContent = fpsCounter.frames.toString();
        fpsCounter.frames = 0;
        fpsCounter.last = ts;
      }
      hudTime.textContent = current.toFixed(2) + 's';

      if (state.playing) {
        state.currentTime += dt;
        playheadEl.style.left = timeToPx(state.currentTime) + 'px';
      }
      requestAnimationFrame(renderPreview);
    }
    requestAnimationFrame(renderPreview);

    // Play controls
    document.getElementById('btn-play').onclick = () => { state.playing = true; toast('Play'); };
    document.getElementById('btn-pause').onclick = () => { state.playing = false; toast('Pause'); };
    document.getElementById('btn-stop').onclick = () => { state.playing = false; state.currentTime = 0; playheadEl.style.left = '0px'; toast('Stop'); };

    // --- Scopes ---
    const scopeWave = document.getElementById('scope-waveform').getContext('2d');
    const scopeVec = document.getElementById('scope-vectorscope').getContext('2d');
    function renderScopes() {
      // Waveform
      scopeWave.clearRect(0,0,scopeWave.canvas.width, scopeWave.canvas.height);
      scopeWave.strokeStyle = 'rgba(0,209,255,0.7)';
      scopeWave.beginPath();
      for (let x=0; x<scopeWave.canvas.width; x++){
        const y = scopeWave.canvas.height/2 + Math.sin((x + performance.now()/10)/12) * 28;
        x===0 ? scopeWave.moveTo(x,y) : scopeWave.lineTo(x,y);
      }
      scopeWave.stroke();
      // Vectorscope
      scopeVec.clearRect(0,0,scopeVec.canvas.width, scopeVec.canvas.height);
      scopeVec.strokeStyle = 'rgba(0,209,255,0.7)';
      scopeVec.beginPath();
      const cx = scopeVec.canvas.width/2, cy = scopeVec.canvas.height/2;
      for (let a=0; a<Math.PI*2; a+=0.05){
        const r = 40 + Math.sin(a*3 + performance.now()/400)*10;
        const x = cx + Math.cos(a)*r;
        const y = cy + Math.sin(a)*r;
        a===0 ? scopeVec.moveTo(x,y) : scopeVec.lineTo(x,y);
      }
      scopeVec.stroke();
      requestAnimationFrame(renderScopes);
    }
    renderScopes();
    document.getElementById('btn-scope').onclick = () => toast('Scopes refreshed');

    // --- Color grading controls ---
    function bindSlider(id, key, fmt = (v)=>v) {
      const el = document.getElementById(id);
      const lbl = document.getElementById(id + '-val');
      el.oninput = () => { state.grading[key] = parseFloat(el.value); lbl.textContent = fmt(el.value); };
    }
    bindSlider('grade-exposure', 'exposure', v => Number(v).toFixed(2));
    bindSlider('grade-contrast', 'contrast', v => Number(v).toFixed(2));
    bindSlider('grade-sat', 'sat', v => Number(v).toFixed(2));
    bindSlider('grade-temp', 'temp', v => Number(v).toFixed(2));
    bindSlider('grade-tint', 'tint', v => Number(v).toFixed(2));

    document.getElementById('btn-load-lut').onclick = () => {
      const file = document.getElementById('lut-file').files?.[0];
      if (!file) return toast('Select a LUT file (.cube/.3dl).');
      const reader = new FileReader();
      reader.onload = () => { state.grading.lut = reader.result; toast('LUT loaded. Applied in export.'); };
      reader.readAsText(file);
    };

    // --- Audio mix controls ---
    function bindAudio(id, key) {
      const el = document.getElementById(id);
      const lbl = document.getElementById(id + '-val');
      el.oninput = () => { state.audio[key] = parseFloat(el.value); lbl.textContent = Number(el.value).toFixed(2); };
    }
    bindAudio('audio-master','master');
    bindAudio('audio-duck','duck');
    document.getElementById('btn-audio-mute').onclick = () => { state.audio.mute = !state.audio.mute; toast(state.audio.mute ? 'Muted' : 'Unmuted'); };
    document.getElementById('btn-audio-solo').onclick = () => { state.audio.solo = !state.audio.solo; toast(state.audio.solo ? 'Solo mode' : 'All tracks'); };

    // --- Motion/keyframes controls ---
    function bindMotion(id, key, fmt) {
      const el = document.getElementById(id);
      const lbl = document.getElementById(id + '-val');
      el.oninput = () => { state.motion[key] = parseFloat(el.value); lbl.textContent = fmt ? fmt(el.value) : el.value; };
    }
    bindMotion('motion-x','x');
    bindMotion('motion-y','y');
    bindMotion('motion-scale','scale');
    bindMotion('motion-rot','rot', v => `${Math.round(v)}°`);

    document.getElementById('btn-ease-in').onclick = () => { state.motion.ease = 'ease-in'; toast('Ease In set'); };
    document.getElementById('btn-ease-out').onclick = () => { state.motion.ease = 'ease-out'; toast('Ease Out set'); };
    document.getElementById('btn-ease-inout').onclick = () => { state.motion.ease = 'ease-in-out'; toast('Ease In-Out set'); };

    document.getElementById('btn-add-key').onclick = () => {
      if (!state.selection) return toast('Select a clip first (double-click).');
      const id = state.selection;
      const arr = state.keyframes[id] || [];
      arr.push({ t: state.currentTime, props: JSON.parse(JSON.stringify(state.motion)) });
      state.keyframes[id] = arr;
      pushHistory();
      toast(`Keyframe added @ ${state.currentTime.toFixed(2)}s`);
    };

    // Clip selection (double-click) to edit
    timelineGrid.addEventListener('dblclick', (ev) => {
      const clipEl = ev.target.closest('.clip');
      if (!clipEl) return;
      state.selection = clipEl.getAttribute('data-id');
      clipEl.style.boxShadow = '0 0 16px rgba(0,209,255,0.9), inset 0 0 24px rgba(0,209,255,0.24)';
      toast('Clip selected. Motion & text controls active.');
    });

    // --- Text controls ---
    const textContentEl = document.getElementById('text-content');
    const textSizeEl = document.getElementById('text-size');
    const textTrackEl = document.getElementById('text-track');
    document.getElementById('text-size-val').textContent = textSizeEl.value;
    document.getElementById('text-track-val').textContent = textTrackEl.value;

    textContentEl.oninput = () => state.text.content = textContentEl.value.toUpperCase();
    textSizeEl.oninput = () => { state.text.size = parseInt(textSizeEl.value,10); document.getElementById('text-size-val').textContent = textSizeEl.value; };
    textTrackEl.oninput = () => { state.text.track = parseFloat(textTrackEl.value); document.getElementById('text-track-val').textContent = textTrackEl.value; };
    document.getElementById('btn-text-glow').onclick = () => { state.text.glow = !state.text.glow; toast(state.text.glow ? 'Glow on' : 'Glow off'); };
    document.getElementById('btn-text-typewriter').onclick = () => { state.text.anim = 'typewriter'; toast('Typewriter animation'); };
    document.getElementById('btn-text-slide').onclick = () => { state.text.anim = 'slide'; toast('Slide-in animation'); };
    document.getElementById('btn-text-anim').onclick = () => { state.text.anim = 'fade'; toast('Fade animation'); };

    // Add text element as a clip
    document.getElementById('btn-add-text').onclick = () => {
      const t = state.tracks.find(T => T.type === 'text') || state.tracks.find(T => T.type === 'video');
      const id = 'clip_' + Math.random().toString(36).slice(2, 8);
      state.clips.push({ id, trackId: t.id, start: state.currentTime, duration: 3, type: 'text', text: JSON.parse(JSON.stringify(state.text)), params: { transition: 'fade', effects: [] } });
      pushHistory();
      renderTimeline();
    };

    // --- Fullscreen ---
    const btnFullscreen = document.getElementById('btn-fullscreen');
    btnFullscreen.onclick = () => {
      document.body.classList.toggle('fullscreen');
      toast(document.body.classList.contains('fullscreen') ? 'Fullscreen on' : 'Fullscreen off');
    };

    // --- Save/Load Project ---
    const btnSave = document.getElementById('btn-save');
    btnSave.onclick = () => {
      const session = JSON.parse(localStorage.getItem(authStore.sessionKey) || '{}');
      const key = `qc_project_${session.username || 'demo'}`;
      const data = {
        meta: { name: state.projectName, updated: Date.now() },
        state: {
          tracks: state.tracks, clips: state.clips, keyframes: state.keyframes,
          grading: state.grading, audio: state.audio, motion: state.motion, text: state.text
        }
      };
      localStorage.setItem(key, JSON.stringify(data));
      toast('Project saved locally.');
    };

    // --- Import/Export ---
    const btnImport = document.getElementById('btn-import');
    const btnExport = document.getElementById('btn-export');

    btnImport.onclick = () => fileInput.click();

    // FFmpeg.wasm setup (basic)
    const { createFFmpeg } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });

    async function ensureFFmpeg() {
      if (!ffmpeg.isLoaded()) {
        toast('Booting FFmpeg.wasm…');
        try {
          await ffmpeg.load();
          toast('FFmpeg ready.');
        } catch (e) {
          toast('FFmpeg failed to load.');
        }
      }
    }

    // Simple one-click export that assembles a preview video from timeline snapshots
    btnExport.onclick = async () => {
      await ensureFFmpeg();
      toast('Rendering preview frames…');

      // Render N frames from preview canvas as PNGs and then encode to MP4 (H.264) or WebM
      const fps = 30;
      const duration = Math.max(3, state.clips.reduce((acc, c) => Math.max(acc, c.start + c.duration), 0));
      const totalFrames = Math.min(300, Math.ceil(fps * duration)); // cap for demo
      const off = document.createElement('canvas');
      off.width = previewCanvas.width;
      off.height = previewCanvas.height;
      const offctx = off.getContext('2d');

      // Simulate timeline playback for export
      const originalTime = state.currentTime;
      const originalPlaying = state.playing;
      state.playing = false;

      for (let i=0;i<totalFrames;i++){
        state.currentTime = i / fps;
        // Draw current preview into offscreen
        offctx.fillStyle = '#000';
        offctx.fillRect(0,0,off.width, off.height);
        // quick draw of preview canvas onto offscreen
        offctx.drawImage(previewCanvas, 0, 0);
        const blob = await new Promise(res => off.toBlob(res, 'image/png'));
        const arrayBuffer = await blob.arrayBuffer();
        ffmpeg.FS('writeFile', `frame_${String(i).padStart(4,'0')}.png`, new Uint8Array(arrayBuffer));
      }

      toast('Encoding video…');

      // Encode to WebM for browser speed
      try {
        await ffmpeg.run(
          '-framerate', String(fps),
          '-i', 'frame_%04d.png',
          '-c:v', 'libvpx',
          '-pix_fmt', 'yuv420p',
          '-b:v', '1M',
          'out.webm'
        );
        const data = ffmpeg.FS('readFile', 'out.webm');
        const blob = new Blob([data.buffer], { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'QuantumCut.webm';
        a.click();
        toast('Export complete (WebM).');
      } catch (err) {
        toast('Export failed.');
      }

      // Cleanup
      for (let i=0;i<totalFrames;i++){
        try { ffmpeg.FS('unlink', `frame_${String(i).padStart(4,'0')}.png`); } catch {}
      }
      state.currentTime = originalTime;
      state.playing = originalPlaying;
    };

    // --- One-click export options ---
    const exportFormats = [
      { id: 'mp4', name: 'MP4 (H.264)', args: ['-c:v','libx264','-pix_fmt','yuv420p','-crf','23'] },
      { id: 'webm', name: 'WebM (VP9)', args: ['-c:v','libvpx-vp9','-pix_fmt','yuv420p','-b:v','1M'] },
      { id: 'mov', name: 'MOV (H.264)', args: ['-c:v','libx264','-pix_fmt','yuv420p','-crf','23'] },
    ];

    // --- Keyboard Shortcuts ---
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') { e.preventDefault(); document.getElementById('btn-save').click(); }
      if (e.key === ' ') { e.preventDefault(); state.playing = !state.playing; toast(state.playing ? 'Play' : 'Pause'); }
      if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
      if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
    });

    // --- Magnet/Snap toggles ---
    document.getElementById('btn-magnet').onclick = (e) => {
      e.currentTarget.classList.toggle('qc-btn-danger');
      toast(e.currentTarget.classList.contains('qc-btn-danger') ? 'Magnet on' : 'Magnet off');
    };
    document.getElementById('btn-snap').onclick = (e) => {
      e.currentTarget.classList.toggle('qc-btn-danger');
      toast(e.currentTarget.classList.contains('qc-btn-danger') ? 'Snap to grid on' : 'Snap to grid off');
    };

    // --- Import/Export MP4, MOV, WebM via file input and ffmpeg ---
    document.getElementById('btn-import').title = 'Import MP4, MOV, WebM, audio, images';
  </script>
</body>
</html>
